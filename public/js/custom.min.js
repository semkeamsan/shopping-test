(function () {
    "use strict";
    var languages, lang, __ = (t) => {
        return window.languages[t] ?? t;
    }

    var Tabledropdown = function () {
        var e = $('.table-dropdown')
        // hold onto the drop down menu
        var dropdownMenu;

        // and when you show it, move it to the body
        $(window).on('show.bs.dropdown', function (e) {

            if ($(e.target).parents('table').length) {
                // grab the menu
                dropdownMenu = $(e.target).find('.dropdown-menu');
                // detach it and append it to the body
                $('body').append(dropdownMenu.detach());

                // grab the new offset position
                var eOffset = $(e.target).offset();

                // make sure to place it where it would normally go (this could be improved)
                dropdownMenu.css({
                    'display': 'block',
                    'top': eOffset.top + $(e.target).outerHeight(),
                    'left': eOffset.left - 50
                });
            }
        });



        // and when you hide it, reattach the drop down, and hide it normally
        $(window).on('hide.bs.dropdown', function (e) {
            if ($(e.target).parents('table').length) {
                $(e.target).append(dropdownMenu.detach());
                dropdownMenu.hide();
            }
        });
    }();
    var validation = function (form) {
        form.addEventListener(
            "submit",
            function (event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                    if ($.notify)
                        $.notify({
                            icon: 'fal fa-times-circle',
                            message: __('Unsuccessfully'),
                            url: ""
                        }, {
                            element: "body",
                            type: 'danger',
                            placement: {
                                from: 'top',
                                align: 'right'
                            },
                            offset: {
                                x: 15,
                                y: 15
                            },
                            delay: 2500,
                            url_target: "_blank",
                            template: '<div data-notify="container" class="alert alert-dismissible alert-{0} alert-notify w-auto" role="alert"><span class="alert-icon" data-notify="icon"></span> <div class="alert-text"</div> <span class="alert-title" data-notify="title">{1}</span> <span data-notify="message">{2}</span></div><button type="button" class="close" data-notify="dismiss" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'
                        });
                }
                form.classList.add("was-validated");
            },
            false
        );
    };
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.getElementsByClassName("needs-validation");
    // Loop over them and prevent submission
    Array.prototype.filter.call(forms, function (form) {
        validation(form);
    });


    var $template = $('.template');

      // Attributes
      $(document).on('click', '#new-attribute', function (e) {
          var index = (new Date()).getTime();
          var attribute = $template.find('>.attribute').clone().html();
          attribute = attribute.replaceAll('{0}', index);
          attribute = attribute.replaceAll('{1}', (new Date()).getTime());
          attribute = attribute.replaceAll('{2}', (new Date()).getTime());
          var $attribute = $(attribute);
          $('#accordion-attribute').append($attribute);
          $attribute.find('input:first').focus();
          $attribute.find('select').select2().val(0).trigger('change');
          $(`[data-toggle="ui-drag"]`).sortable({});
          //$('div#lfm-image').filemanager('image', {prefix: route_prefix});
          //$('button#lfm-file').filemanager('file', {prefix: route_prefix});


          // $attribute.find(`#lfm-image:first`).filemanager({
          //     url: 'filemanager',
          //     _token: $('meta[name="csrf-token"]').attr("content"),
          //     multiple: false,
          //     query: {
          //         extension: 'image'
          //     },
          // });
      });

      $(document).on('click', '#attribute-delete', function (e) {
          $(this).parents('.card#attribute').remove();
      });


      // Options
      $(document).on('click', '#new-option', function (e) {
          var $card = $(this).parents('.card#attribute');
          var index = $card.data('index');
          var oindex = (new Date()).getTime();
          var option = $template.find('.option').clone().prop('outerHTML');
          option = option.replaceAll('{0}', index);
          option = option.replaceAll('{1}', oindex);
          option = option.replaceAll('{2}', (new Date()).getTime());
          var $option = $(option)
          $card.find(`#options`).append($option);
          $option.find('input:first').focus();
          $option.find('select').select2().val(0).trigger('change');
          $(`[data-toggle="ui-drag"]`).sortable({});
          //$('div#lfm-image').filemanager('image', {prefix: route_prefix});
          //$('button#lfm-file').filemanager('file', {prefix: route_prefix});

          //    $option.find(`#lfm-image:first`).filemanager({
          //     url: 'filemanager',
          //     _token: $('meta[name="csrf-token"]').attr("content"),
          //     multiple: false,
          //     query: {
          //         extension: 'image'
          //     },
          // });

      });


      $(document).on('click', '#option-delete', function (e) {
          $(this).parents('.card#option').remove();
      });


      $(document).on('change', `[data-toggle="virtual"]`, function (e) {
          var $card = $(this).parents('.card#option');
          var target = $(this).data('target');
          $card.find(target).toggle();
      });
      $(document).on('change', `[data-toggle="downloadedable"]`, function (e) {
          var $card = $(this).parents('.card#option');
          var target = $(this).data('target');
          $card.find(target).toggle();
      });

      $(document).on('change', `[data-toggle="manage_stock"]`, function (e) {
          var $card = $(this).parents('.card#option');
          var target = $(this).data('target');
          $card.find(target).toggle();
      });





      // Rows
      $(document).on('click', '#new-row', function (e) {
          var $card = $(this).parents('.card#attribute');
          var index = $card.data('index');
          var oindex = $(this).parents('.card#option').data('index');
          var $table = $(this).parents('#option-types').find('table');
          var tr = $template.find('tbody').clone().html();
          tr = tr.replaceAll('{0}', index);
          tr = tr.replaceAll('{1}', oindex);
          tr = tr.replaceAll('{2}', (new Date()).getTime());
          var $tr = $(tr);
          $table.find('tbody').append($tr);
          $tr.find('select').select2();
          changeInputNumber2InputText($tr.find(`[data-toggle="n2t"]`));

          // $('button#lfm-file').filemanager('file', {
          //     prefix: route_prefix
          // });
      });

      $(document).on('click', '#row-delete', function (e) {

          $(this).parents('tr').remove();
      });
})();
